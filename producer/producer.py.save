import time
import json
import os

# --- CONFIGURATION ---
# On √©crit dans un fichier log dans /tmp (accessible √† tous)
LOG_FILE = "g"
DATA_FILE = "movieslens/ratings/u.data" 

print(f"üöÄ D√©marrage du logging vers '{LOG_FILE}'...")

try:
    # On s'assure que le fichier source existe
    if not os.path.exists(DATA_FILE):
        raise FileNotFoundError(f"Le fichier source {DATA_FILE} est introuvable.")

    with open(DATA_FILE, 'r') as f_source, open(LOG_FILE, 'a') as f_log:
        count = 0
        for line in f_source:
            columns = line.split('\t')
            
            # Cr√©ation du dictionnaire
            rating_data = {
                "user_id": int(columns[0]),
                "movie_id": int(columns[1]),
                "rating": int(columns[2]),
                "timestamp": int(columns[3].strip())
            }
            
            # √âCRITURE DANS LE FICHIER (JSON sur une ligne + retour √† la ligne)
            f_log.write(json.dumps(rating_data) + "\n")
            f_log.flush()  # Force l'√©criture imm√©diate sur le disque
            
            count += 1
            if count % 100 == 0:
                print(f"‚úÖ {count} logs √©crits...", end="\r")
            
            time.sleep(0.1) # Simulation temps r√©el

except Exception as e:
    print(f"\n‚ùå ERREUR : {e}")
except KeyboardInterrupt:
    print("\nüõë Arr√™t du logger.")
